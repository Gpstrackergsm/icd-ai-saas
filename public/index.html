<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICD-10-CM Encoder</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6fb;
        color: #1e293b;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 32px 16px 48px;
      }

      h1 {
        font-size: 28px;
        margin-bottom: 16px;
        color: #0f172a;
      }

      .panel {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        padding: 20px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
      }

      .tab {
        padding: 10px 14px;
        background: #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        border: 1px solid #cbd5e1;
      }

      .tab.active {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .input-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      textarea,
      input[type="text"] {
        flex: 1;
        min-width: 220px;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 120px;
      }

      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 8px;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      button:hover {
        background: #1d4ed8;
      }

      button.secondary {
        background: #0ea5e9;
      }

      button.secondary:hover {
        background: #0284c7;
      }

      .status {
        margin-top: 12px;
        color: #475569;
        min-height: 20px;
      }

      .results {
        margin-top: 20px;
        display: grid;
        gap: 12px;
      }

      .card {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 14px;
        background: #f8fafc;
      }

      .code {
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 6px;
      }

      .desc {
        margin: 4px 0;
        color: #334155;
      }

      .synonyms {
        font-size: 13px;
        color: #64748b;
      }

      .actions {
        margin-top: 16px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .hidden {
        display: none;
      }

      .pill {
        display: inline-block;
        padding: 4px 8px;
        background: #e0f2fe;
        color: #0369a1;
        border-radius: 6px;
        font-size: 12px;
        margin-right: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ICD-10-CM Encoder</h1>
      <div class="panel">
        <div class="tabs">
          <div class="tab active" data-tab="search">Search</div>
          <div class="tab" data-tab="encode">Encoder</div>
        </div>

        <div id="searchPanel">
          <label for="query">Search ICD codes</label>
          <div class="input-row">
            <textarea
              id="query"
              name="query"
              placeholder="Enter code, condition, or synonym"
            ></textarea>
            <button id="searchBtn">Search</button>
          </div>
          <div class="actions">
            <button id="copyBtn" class="secondary" disabled>Copy results</button>
          </div>
          <div id="status" class="status"></div>
          <div id="results" class="results"></div>
        </div>

        <div id="encodePanel" class="hidden">
          <label for="narrative">Encoder: clinical narrative</label>
          <div class="input-row">
            <textarea
              id="narrative"
              name="narrative"
              placeholder="e.g., Type 2 diabetes with CKD stage 4 and hypertension"
            ></textarea>
            <button id="encodeBtn">Encode</button>
          </div>
          <div class="actions">
            <button id="copyEncodeBtn" class="secondary" disabled>Copy codes</button>
          </div>
          <div id="encodeStatus" class="status"></div>
          <div id="encodeResults" class="results"></div>
        </div>
      </div>
    </div>

    <script>
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const searchPanel = document.getElementById('searchPanel');
      const encodePanel = document.getElementById('encodePanel');

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          tabs.forEach((t) => t.classList.remove('active'));
          tab.classList.add('active');
          const isSearch = tab.dataset.tab === 'search';
          searchPanel.classList.toggle('hidden', !isSearch);
          encodePanel.classList.toggle('hidden', isSearch);
        });
      });

      const queryInput = document.getElementById('query');
      const searchBtn = document.getElementById('searchBtn');
      const copyBtn = document.getElementById('copyBtn');
      const status = document.getElementById('status');
      const resultsEl = document.getElementById('results');

      let lastRendered = null;

      function renderSearchResults(items) {
        resultsEl.innerHTML = '';
        if (!items.length) {
          resultsEl.innerHTML = '<p>No results found.</p>';
          copyBtn.disabled = true;
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'card';

          const code = document.createElement('div');
          code.className = 'code';
          code.textContent = item.code;

          const desc = document.createElement('div');
          desc.className = 'desc';
          desc.textContent = item.description || '';

          const badge = document.createElement('span');
          badge.className = 'pill';
          badge.textContent = item.matchedTerm ? `Matched: ${item.matchedTerm}` : 'Index';

          card.appendChild(code);
          card.appendChild(desc);
          card.appendChild(badge);
          fragment.appendChild(card);
        });

        resultsEl.appendChild(fragment);
        copyBtn.disabled = false;
      }

      async function fetchPayload(url, body, defaultError) {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const data = await response.json().catch(() => ({}));
        const message =
          data?.error?.message || data?.message || data?.error || defaultError;

        if (!response.ok || data?.success === false) {
          throw new Error(message);
        }

        return data?.data ?? data;
      }

      async function performSearch() {
        const query = queryInput.value.trim();
        resultsEl.innerHTML = '';
        status.textContent = '';
        copyBtn.disabled = true;

        if (!query) {
          status.textContent = 'Please enter a search query.';
          return;
        }

        searchBtn.disabled = true;
        status.textContent = 'Searching…';

        try {
          const payload = await fetchPayload(
            '/api/search',
            { query },
            'Search failed'
          );
          lastRendered = payload.results || [];
          renderSearchResults(lastRendered);
          status.textContent = `Found ${lastRendered.length} result(s).`;
        } catch (err) {
          status.textContent = err.message || 'Unable to search right now.';
        } finally {
          searchBtn.disabled = false;
        }
      }

      async function copyResults() {
        const cards = Array.from(resultsEl.querySelectorAll('.card'));
        if (!cards.length || !lastRendered) return;

        const lines = cards.map((card) => {
          const code = card.querySelector('.code')?.textContent || '';
          const desc = card.querySelector('.desc')?.textContent || '';
          return `${code} — ${desc}`;
        });
        try {
          await navigator.clipboard.writeText(lines.join('\n'));
          status.textContent = 'Results copied to clipboard.';
        } catch (err) {
          status.textContent = 'Unable to copy results.';
        }
      }

      searchBtn.addEventListener('click', performSearch);
      copyBtn.addEventListener('click', copyResults);

      // Encoder tab logic
      const narrativeInput = document.getElementById('narrative');
      const encodeBtn = document.getElementById('encodeBtn');
      const copyEncodeBtn = document.getElementById('copyEncodeBtn');
      const encodeStatus = document.getElementById('encodeStatus');
      const encodeResults = document.getElementById('encodeResults');
      let lastEncoded = null;

      function renderEncodeResults(payload) {
        encodeResults.innerHTML = '';
        if (!payload.codes?.length) {
          encodeResults.innerHTML = '<p>No codes suggested.</p>';
          copyEncodeBtn.disabled = true;
          return;
        }

        const fragment = document.createDocumentFragment();
        payload.codes.forEach((code) => {
          const card = document.createElement('div');
          card.className = 'card';

          const codeEl = document.createElement('div');
          codeEl.className = 'code';
          codeEl.textContent = `${code.order}. ${code.code}`;

          const desc = document.createElement('div');
          desc.className = 'desc';
          desc.textContent = code.description || '';

          const reason = document.createElement('div');
          reason.className = 'synonyms';
          reason.textContent = `Reason: ${code.reason}`;

          card.appendChild(codeEl);
          card.appendChild(desc);
          card.appendChild(reason);
          fragment.appendChild(card);
        });

        if (payload.warnings?.length) {
          const warnCard = document.createElement('div');
          warnCard.className = 'card';
          warnCard.innerHTML = `<div class="code">Warnings</div><div class="desc">${payload.warnings.join('<br/>')}</div>`;
          fragment.appendChild(warnCard);
        }

        if (payload.errors?.length) {
          const errCard = document.createElement('div');
          errCard.className = 'card';
          errCard.innerHTML = `<div class="code">Errors</div><div class="desc">${payload.errors.join('<br/>')}</div>`;
          fragment.appendChild(errCard);
        }

        encodeResults.appendChild(fragment);
        copyEncodeBtn.disabled = false;
      }

      async function performEncode() {
        const text = narrativeInput.value.trim();
        encodeResults.innerHTML = '';
        encodeStatus.textContent = '';
        copyEncodeBtn.disabled = true;

        if (!text) {
          encodeStatus.textContent = 'Please enter a clinical narrative.';
          return;
        }

        encodeBtn.disabled = true;
        encodeStatus.textContent = 'Encoding…';

        try {
          const payload = await fetchPayload(
            '/api/encode',
            { text },
            'Encoding failed'
          );
          lastEncoded = payload;
          renderEncodeResults(payload);
          encodeStatus.textContent = `Found ${payload.codes?.length || 0} code(s).`;
        } catch (err) {
          encodeStatus.textContent = err.message || 'Unable to encode right now.';
        } finally {
          encodeBtn.disabled = false;
        }
      }

      async function copyEncodedCodes() {
        if (!lastEncoded?.codes?.length) return;
        const lines = lastEncoded.codes.map((code) => `${code.code} — ${code.description}`);
        try {
          await navigator.clipboard.writeText(lines.join('\n'));
          encodeStatus.textContent = 'Codes copied to clipboard.';
        } catch (err) {
          encodeStatus.textContent = 'Unable to copy codes.';
        }
      }

      encodeBtn.addEventListener('click', performEncode);
      copyEncodeBtn.addEventListener('click', copyEncodedCodes);
    </script>
  </body>
</html>
