<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICD-10-CM Encoder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fef2f2;
      color: #1e293b;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 16px;
      color: #0f172a;
    }

    .panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      padding: 20px;
    }


    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .input-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    textarea,
    input[type="text"] {
      flex: 1;
      min-width: 220px;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      min-height: 120px;
    }

    button {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    button:hover {
      background: #dc2626;
    }

    button.secondary {
      background: #64748b;
    }

    button.secondary:hover {
      background: #475569;
    }

    .status {
      margin-top: 12px;
      color: #475569;
      min-height: 20px;
    }

    .results {
      margin-top: 20px;
      display: grid;
      gap: 12px;
    }

    .card {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 14px;
      background: #f8fafc;
    }

    .code {
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 6px;
    }

    .desc {
      margin: 4px 0;
      color: #334155;
    }

    .synonyms {
      font-size: 13px;
      color: #64748b;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .hidden {
      display: none;
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      background: #fee2e2;
      color: #991b1b;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ICD-10-CM Encoder</h1>
    <div class="panel">

      <div id="encodePanel">
        <label for="narrative">Encoder: clinical narrative</label>
        <div class="input-row">
          <textarea id="narrative" name="narrative"
            placeholder="e.g., Type 2 diabetes with CKD stage 4 and hypertension"></textarea>
          <button id="encodeBtn">Encode</button>
        </div>
        <div class="actions">
          <button id="copyEncodeBtn" class="secondary" disabled>Copy codes</button>
        </div>
        <div id="encodeStatus" class="status"></div>
        <div id="encodeResults" class="results"></div>
      </div>
    </div>
  </div>

  <script>

    // Encoder tab logic
    const narrativeInput = document.getElementById('narrative');
    const encodeBtn = document.getElementById('encodeBtn');
    const copyEncodeBtn = document.getElementById('copyEncodeBtn');
    const encodeStatus = document.getElementById('encodeStatus');
    const encodeResults = document.getElementById('encodeResults');
    let lastEncoded = null;

    function renderEncodeResults(payload) {
      encodeResults.innerHTML = '';

      // Normalize payload to array
      const results = Array.isArray(payload) ? payload : [payload];

      if (!results.length) {
        encodeResults.innerHTML = '<p>No results returned.</p>';
        return;
      }

      const fragment = document.createDocumentFragment();

      results.forEach((result, index) => {
        // Container for this result item
        const itemContainer = document.createElement('div');
        itemContainer.className = 'result-item';
        itemContainer.style.marginBottom = '24px';

        // Header for the item if batch
        if (results.length > 1) {
          const header = document.createElement('h3');
          header.textContent = `Item ${index + 1}: ${result.text}`;
          header.style.fontSize = '16px';
          header.style.color = '#334155';
          header.style.marginBottom = '12px';
          header.style.borderBottom = '1px solid #e2e8f0';
          header.style.paddingBottom = '8px';
          itemContainer.appendChild(header);
        }

        if (!result.primary && (!result.secondary || !result.secondary.length)) {
          const noCode = document.createElement('div');
          noCode.className = 'card';
          noCode.textContent = 'No codes suggested.';
          itemContainer.appendChild(noCode);
        } else {
          const createCard = (code, type) => {
            const card = document.createElement('div');
            card.className = 'card';
            if (type === 'Primary') {
              card.style.borderLeft = '4px solid #ef4444';
            }

            const codeEl = document.createElement('div');
            codeEl.className = 'code';
            codeEl.textContent = `${type}: ${code.code}`;

            const desc = document.createElement('div');
            desc.className = 'desc';
            desc.textContent = code.description || '';

            const reason = document.createElement('div');
            reason.className = 'synonyms';
            reason.textContent = `Rationale: ${code.rationale}`;

            card.appendChild(codeEl);
            card.appendChild(desc);
            card.appendChild(reason);
            return card;
          };

          if (result.primary) {
            itemContainer.appendChild(createCard(result.primary, 'Primary'));
          }

          if (result.secondary && result.secondary.length) {
            result.secondary.forEach((code) => {
              itemContainer.appendChild(createCard(code, 'Secondary'));
            });
          }
        }

        if (result.warnings?.length) {
          const warnCard = document.createElement('div');
          warnCard.className = 'card';
          warnCard.innerHTML = `<div class="code">Warnings</div><div class="desc">${result.warnings.join('<br/>')}</div>`;
          itemContainer.appendChild(warnCard);
        }

        if (result.errors?.length) {
          const errCard = document.createElement('div');
          errCard.className = 'card';
          errCard.innerHTML = `<div class="code">Errors</div><div class="desc">${result.errors.join('<br/>')}</div>`;
          itemContainer.appendChild(errCard);
        }

        fragment.appendChild(itemContainer);
      });

      encodeResults.appendChild(fragment);
      copyEncodeBtn.disabled = false;
    }

    async function fetchPayload(url, body, defaultError) {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const data = await response.json().catch(() => ({}));
      const message =
        data?.error?.message || data?.message || data?.error || defaultError;

      if (!response.ok || data?.success === false) {
        throw new Error(message);
      }

      return data?.data ?? data;
    }

    async function performEncode() {
      const text = narrativeInput.value.trim();
      encodeResults.innerHTML = '';
      encodeStatus.textContent = '';
      copyEncodeBtn.disabled = true;

      if (!text) {
        encodeStatus.textContent = 'Please enter a clinical narrative.';
        return;
      }

      encodeBtn.disabled = true;
      encodeStatus.textContent = 'Encoding…';

      // Check for numbered list
      // Regex looks for lines starting with a number followed by dot, paren, or space
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      const isBatch = lines.length > 1 && lines.every(l => /^\d+[\.\)\s]/.test(l.trim()));

      let payloadBody = {};
      if (isBatch) {
        // Extract text after the number
        const items = lines.map(l => l.replace(/^\d+[\.\)\s]\s*/, '').trim());
        payloadBody = { items };
      } else {
        payloadBody = { text };
      }

      try {
        const payload = await fetchPayload(
          '/api/encode',
          payloadBody,
          'Encoding failed'
        );
        lastEncoded = payload;
        renderEncodeResults(payload);

        const count = Array.isArray(payload) ? payload.length : 1;
        encodeStatus.textContent = `Processed ${count} item(s).`;
      } catch (err) {
        encodeStatus.textContent = err.message || 'Unable to encode right now.';
      } finally {
        encodeBtn.disabled = false;
      }
    }

    async function copyEncodedCodes() {
      if (!lastEncoded) return;

      const results = Array.isArray(lastEncoded) ? lastEncoded : [lastEncoded];
      const lines = [];

      results.forEach((res, idx) => {
        if (results.length > 1) lines.push(`Item ${idx + 1}: ${res.text}`);

        if (res.primary) {
          lines.push(`Primary: ${res.primary.code} — ${res.primary.description}`);
        }
        if (res.secondary) {
          res.secondary.forEach((code) => {
            lines.push(`Secondary: ${code.code} — ${code.description}`);
          });
        }
        if (results.length > 1) lines.push(''); // spacer
      });

      if (!lines.length) return;

      try {
        await navigator.clipboard.writeText(lines.join('\n'));
        encodeStatus.textContent = 'Codes copied to clipboard.';
      } catch (err) {
        encodeStatus.textContent = 'Unable to copy codes.';
      }
    }

    encodeBtn.addEventListener('click', performEncode);
    copyEncodeBtn.addEventListener('click', copyEncodedCodes);
  </script>
</body>

</html>