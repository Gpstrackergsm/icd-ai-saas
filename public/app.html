<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DPX4FW21M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-9DPX4FW21M');
  </script>
  <title>ICD-10-CM Encoder - App</title>
  <meta name="description" content="Secure, AI-powered ICD-10-CM encoding workspace.">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="canonical" href="https://www.icd-10-cm.online/app.html" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            medical: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-slate-50 font-sans text-slate-800 antialiased min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-medical-600 flex items-center justify-center text-white">
            <i class="fa-solid fa-laptop-medical"></i>
          </div>
          <span class="text-xl font-bold text-slate-900 tracking-tight">ICD Audit Engine</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="hidden sm:flex flex-col items-end">
            <span id="userEmail" class="text-sm font-medium text-slate-900"></span>
            <span class="text-xs text-green-600 font-semibold">â€¢ Online</span>
          </div>
          <button id="logoutBtn"
            class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
            title="Logout">
            <i class="fa-solid fa-right-from-bracket text-lg"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full gap-8 grid grid-cols-1 lg:grid-cols-3">

    <!-- Left Column: Inputs -->
    <div class="lg:col-span-2 space-y-8 order-2 lg:order-1">

      <!-- Encoder Panel -->
      <section class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
          <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
            <i class="fa-solid fa-keyboard text-medical-500"></i> Clinical Scenario
          </h2>
          <span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800">
            Secure Mode
          </span>
        </div>

        <div class="p-6" id="encodePanel">
          <!-- Dynamic Form Builder Container will be inserted here by JS -->

          <div class="mt-6">
            <label for="narrative" class="block text-sm font-semibold text-slate-700 mb-2">
              Generated Clinical Narrative
              <span class="text-xs font-normal text-slate-500 ml-1">(Editable)</span>
            </label>
            <div class="relative">
              <textarea id="narrative" name="narrative"
                class="w-full h-40 px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-medical-500 focus:border-transparent outline-none transition-all resize-none font-mono text-sm leading-relaxed"
                placeholder="Describe the patient encounter or use the builder above..."></textarea>
              <div class="absolute bottom-3 right-3 text-xs text-slate-400 pointer-events-none">
                AI Ready
              </div>
            </div>
          </div>

          <div class="mt-6 flex items-center gap-4">
            <button id="encodeBtn"
              class="flex-1 bg-medical-600 hover:bg-medical-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Encode Scenario
            </button>
          </div>

          <div id="encodeStatus" class="mt-4 text-center text-sm font-medium min-h-[20px] text-slate-500"></div>

        </div>
      </section>

      <!-- Batch Upload Panel -->
      <section class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
        <div class="p-6 border-b border-slate-100 bg-slate-50">
          <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
            <i class="fa-solid fa-file-arrow-up text-medical-500"></i> Batch Processing
          </h2>
        </div>
        <div class="p-6">
          <p class="text-slate-600 text-sm mb-4">
            Upload a <code class="bg-slate-100 px-1 py-0.5 rounded text-slate-800">.txt</code> file containing multiple
            structured cases for high-volume auditing.
          </p>

          <div
            class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors relative group">
            <input type="file" id="batchFile" accept=".txt"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
            <div class="space-y-2 pointer-events-none">
              <i
                class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 group-hover:text-medical-500 transition-colors"></i>
              <p class="text-sm font-medium text-slate-700">Click to upload or drag and drop</p>
              <p class="text-xs text-slate-500" id="fileLabel">TXT files only</p>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-3">
            <button id="processBatchBtn" disabled
              class="bg-slate-800 hover:bg-slate-900 text-white font-medium py-2 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
              Process Batch
            </button>
            <button id="downloadResultsBtn" style="display:none;"
              class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition-all shadow-sm flex items-center gap-2">
              <i class="fa-solid fa-download"></i> Download Report
            </button>
            <button id="clearBatchBtn"
              class="ml-auto text-slate-500 hover:text-slate-700 font-medium text-sm py-2 px-4">
              Clear
            </button>
          </div>

          <div id="batchStatus" class="mt-4 text-sm font-medium text-slate-600"></div>

          <!-- Progress Bar -->
          <div id="batchProgress" class="hidden mt-4">
            <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
              <div id="progressBar" class="h-full bg-medical-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-xs text-center text-slate-500 mt-2">Initializing...</p>
          </div>

        </div>
      </section>

    </div>

    <!-- Right Column: Results -->
    <div class="lg:col-span-1 order-1 lg:order-2">
      <div class="sticky top-24">
        <section
          class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden flex flex-col max-h-[calc(100vh-8rem)]">
          <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-list-check text-medical-500"></i> Results
            </h2>
            <button id="copyEncodeBtn" disabled
              class="text-xs font-medium text-medical-600 hover:text-medical-700 disabled:text-slate-400 flex items-center gap-1">
              <i class="fa-regular fa-copy"></i> Copy All
            </button>
          </div>

          <div id="encodeResults" class="p-4 overflow-y-auto space-y-4 bg-slate-50/50 flex-grow min-h-[300px]">
            <!-- Results populated here -->
            <div class="text-center py-10 text-slate-400">
              <i class="fa-solid fa-clipboard-list text-4xl mb-3 opacity-20"></i>
              <p class="text-sm">Codes will appear here</p>
            </div>
          </div>
        </section>
      </div>
    </div>

  </main>

  <script>
      // Authentication Logic
      (async function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/';
          return;
        }

        try {
          const response = await fetch('/api/auth/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
            throw new Error('Invalid token');
          }

          const data = await response.json();
          document.getElementById('userEmail').textContent = data.user.email;
        } catch (error) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/';
        }
      })();

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/';
    });

    // --- FORM BUILDER LOGIC ---

    // Domain Configuration
    const domainConfig = {
      demographics: {
        label: 'Demographics',
        icon: 'fa-user',
        fields: [
          { key: 'Age', type: 'number', label: 'Age' },
          { key: 'Gender', type: 'select', label: 'Gender', options: ['Male', 'Female'] },
          { key: 'Encounter Type', type: 'select', label: 'Encounter', options: ['Inpatient', 'Outpatient', 'ED', 'Initial', 'Subsequent'] }
        ]
      },
      diabetes: {
        label: 'Diabetes',
        icon: 'fa-droplet',
        fields: [
          { key: 'Diabetes Type', type: 'select', label: 'Type', options: ['None', 'Type 1', 'Type 2'], required: true },
          {
            key: 'Complications',
            type: 'checkbox-group',
            label: 'Complications',
            options: ['Neuropathy', 'Polyneuropathy', 'Nephropathy/CKD', 'Foot Ulcer', 'Retinopathy', 'Hypoglycemia']
          },
          { key: 'Neuropathy Type', type: 'select', label: 'Neuropathy Type', options: ['Unspecified', 'Polyneuropathy', 'Autonomic', 'Mononeuropathy', 'Other'], showIf: 'Neuropathy' },
          { key: 'CKD Stage', type: 'select', label: 'CKD Stage', options: ['1', '2', '3', '4', '5', 'ESRD'], showIf: 'Nephropathy/CKD' },
          { key: 'Insulin Use', type: 'select', label: 'Insulin Use', options: ['Yes', 'No'] },
          { key: 'Ulcer Site', type: 'select', label: 'Ulcer Site', options: ['Left Foot', 'Right Foot', 'Left Ankle', 'Right Ankle', 'Other'], required: 'if_foot_ulcer', showIf: 'Foot Ulcer' },
          { key: 'Ulcer Severity', type: 'select', label: 'Ulcer Depth', options: ['Skin only', 'Fat layer exposed', 'Muscle exposed', 'Bone exposed'], required: 'if_foot_ulcer', showIf: 'Foot Ulcer' }
        ]
      },
      ckd: {
        label: 'Renal / CKD',
        icon: 'fa-flask',
        fields: [
          { key: 'CKD Present', type: 'select', label: 'CKD Present', options: ['Yes', 'No'] },
          { key: 'CKD Stage', type: 'select', label: 'CKD Stage', options: ['1', '2', '3', '4', '5', 'ESRD'], required: true, showIf: 'Yes' },
          { key: 'Dialysis', type: 'select', label: 'Dialysis', options: ['None', 'Temporary', 'Chronic'], showIf: 'ESRD' },
          { key: 'Acute Kidney Injury', type: 'select', label: 'AKI', options: ['Yes', 'No'] },
          { key: 'Kidney Transplant History', type: 'select', label: 'Transplant', options: ['Yes', 'No'] }
        ]
      },
      cardio: {
        label: 'Cardiovascular',
        icon: 'fa-heart-pulse',
        fields: [
          { key: 'Hypertension', type: 'select', label: 'Hypertension', options: ['Yes', 'No'] },
          { key: 'Heart Failure', type: 'select', label: 'Heart Failure', options: ['None', 'Systolic', 'Diastolic', 'Combined'] },
          { key: 'Heart Failure Acuity', type: 'select', label: 'HF Acuity', options: ['Acute', 'Chronic', 'Acute on chronic'], showIf: 'Systolic|Diastolic|Combined' },
          { key: 'Ischemic Heart Disease', type: 'select', label: 'CAD/IHD', options: ['Yes', 'No'] },
          { key: 'Previous MI', type: 'select', label: 'Prior MI', options: ['Yes', 'No'] },
          { key: 'Atrial Fibrillation', type: 'select', label: 'AFib', options: ['Yes', 'No'] }
        ]
      },
      respiratory: {
        label: 'Respiratory',
        icon: 'fa-lungs',
        fields: [
          { key: 'Respiratory Failure', type: 'select', label: 'Resp Failure', options: ['None', 'Acute', 'Chronic', 'Acute on chronic'] },
          { key: 'COPD', type: 'select', label: 'COPD', options: ['None', 'With infection', 'With exacerbation', 'With both'] },
          { key: 'Asthma', type: 'select', label: 'Asthma', options: ['Yes', 'No'] },
          { key: 'Mechanical Ventilation', type: 'select', label: 'Mech Vent', options: ['Yes', 'No'] },
          { key: 'Ventilation Duration', type: 'number', label: 'Vent Hours', showIf: 'Yes' },
          { key: 'Pneumonia', type: 'select', label: 'Pneumonia', options: ['Yes', 'No'] },
          { key: 'Pneumonia Organism', type: 'select', label: 'Organism', options: ['Pseudomonas', 'MRSA', 'E. coli', 'Viral', 'Unspecified'], showIf: 'Yes' }
        ]
      },
      infection: {
        label: 'Infections',
        icon: 'fa-bacterium',
        fields: [
          { key: 'Infection Present', type: 'select', label: 'Infection', options: ['Yes', 'No'] },
          { key: 'Infection Site', type: 'select', label: 'Site', options: ['Lung', 'Urinary tract', 'Blood', 'Skin', 'Other'], showIf: 'Yes' },
          { key: 'Organism', type: 'select', label: 'Organism', options: ['MRSA', 'E. coli', 'Pseudomonas', 'Not specified'], showIf: 'Yes' },
          { key: 'Sepsis', type: 'select', label: 'Sepsis', options: ['Yes', 'No'] },
          { key: 'Septic Shock', type: 'select', label: 'Septic Shock', options: ['Yes', 'No'], showIf: 'Yes' },
          { key: 'Hospital-Acquired', type: 'select', label: 'HAI', options: ['Yes', 'No'], showIf: 'Yes' }
        ]
      },
      wounds: {
        label: 'Wounds / Ulcers',
        icon: 'fa-bandage',
        fields: [
          { key: 'Ulcer Present', type: 'select', label: 'Ulcer/Wound', options: ['Yes', 'No'] },
          { key: 'Ulcer Type', type: 'select', label: 'Type', options: ['Pressure', 'Diabetic', 'Traumatic'], required: true, showIf: 'Yes' },
          { key: 'Ulcer Location', type: 'select', label: 'Location', options: ['Sacral', 'Right foot', 'Left foot', 'Heel', 'Other'], required: true, showIf: 'Yes' },
          { key: 'Ulcer Stage', type: 'select', label: 'Stage/Depth', options: ['Stage 1', 'Stage 2', 'Stage 3', 'Stage 4', 'Muscle necrosis', 'Bone necrosis'], required: true, showIf: 'Yes' }
        ]
      },
      neoplasm: {
        label: 'Neoplasm / Cancer',
        icon: 'fa-ribbon',
        fields: [
          { key: 'Cancer Present', type: 'select', label: 'Cancer', options: ['Yes', 'No'] },
          { key: 'Cancer Site', type: 'text', label: 'Site', showIf: 'Yes' },
          { key: 'Primary or Secondary', type: 'select', label: 'Type', options: ['Primary', 'Secondary'], showIf: 'Yes' },
          { key: 'Metastasis', type: 'select', label: 'Metastasis', options: ['Yes', 'No'], showIf: 'Yes' },
          { key: 'Active Treatment', type: 'select', label: 'Active Tx', options: ['Yes', 'No'], showIf: 'Yes' }
        ]
      },
      injury: {
        label: 'Injury / Trauma',
        icon: 'fa-crutch',
        fields: [
          { key: 'Injury Present', type: 'select', label: 'Injury', options: ['Yes', 'No'] },
          { key: 'Injury Type', type: 'select', label: 'Type', options: ['Fracture', 'Open wound', 'Burn'], required: true, showIf: 'Yes' },
          { key: 'Body Region', type: 'text', label: 'Body Region', showIf: 'Yes' },
          { key: 'Laterality', type: 'select', label: 'Laterality', options: ['Left', 'Right', 'Bilateral'], showIf: 'Yes' },
          { key: 'Injury Encounter Type', type: 'select', label: 'Encounter', options: ['Initial', 'Subsequent', 'Sequela'], required: true, showIf: 'Yes' },
          { key: 'External Cause', type: 'select', label: 'Ext Cause', options: ['Fall', 'MVC', 'Assault', 'Sports', 'Other'], showIf: 'Yes' }
        ]
      },
      social: {
        label: 'Social / Lifestyle',
        icon: 'fa-champagne-glasses',
        fields: [
          { key: 'Smoking', type: 'select', label: 'Smoking', options: ['Never', 'Current', 'Former'] },
          { key: 'Alcohol Use', type: 'select', label: 'Alcohol', options: ['None', 'Yes'] },
          { key: 'Drug Use', type: 'select', label: 'Drug Use', options: ['None', 'Yes'] }
        ]
      }
    };

    let formState = {
      demographics: { Age: '', Gender: '' }
    };

    // DOM Elements
    const encodePanel = document.getElementById('encodePanel');
    const narrativeInput = document.getElementById('narrative');
    const encodeBtn = document.getElementById('encodeBtn');
    const copyEncodeBtn = document.getElementById('copyEncodeBtn');
    const encodeStatus = document.getElementById('encodeStatus');
    const encodeResults = document.getElementById('encodeResults');

    // Builder Container
    const builderContainer = document.createElement('div');
    builderContainer.className = 'border border-slate-200 bg-slate-50/50 rounded-lg p-5 mb-6';

    // Header for builder
    const builderHeader = document.createElement('div');
    builderHeader.className = 'flex justify-between items-center mb-4';
    const builderTitle = document.createElement('h3');
    builderTitle.className = 'text-sm font-bold text-slate-700 uppercase tracking-wide';
    builderTitle.textContent = 'Structured Builder';
    builderHeader.appendChild(builderTitle);

    // Add Condition Wrapper
    const addWrapper = document.createElement('div');
    addWrapper.className = 'relative inline-block';
    const addSelect = document.createElement('select');
    // Removed appearance-none and custom icon to ensure native OS dropdown works reliably
    addSelect.className = 'pl-3 pr-10 py-2 text-sm bg-white border border-slate-300 rounded-md focus:ring-2 focus:ring-medical-500 outline-none shadow-sm cursor-pointer hover:border-medical-400 transition-colors';

    // Add customized default option
    const defaultOpt = document.createElement('option');
    defaultOpt.text = '+ Add Condition';
    defaultOpt.value = '';
    defaultOpt.selected = true;
    addSelect.appendChild(defaultOpt);

    Object.keys(domainConfig).forEach(key => {
      if (key === 'demographics') return;
      const opt = document.createElement('option');
      opt.value = key;
      opt.text = domainConfig[key].label;
      addSelect.appendChild(opt);
    });

    addSelect.addEventListener('change', (e) => {
      const domain = e.target.value;
      if (domain) {
        if (!formState[domain]) {
          formState[domain] = {};
          const section = renderFormSection(domain);
          activeFormsContainer.appendChild(section);
          updateNarrative();
        }
        e.target.value = '';
      }
    });

    addWrapper.appendChild(addSelect);
    builderHeader.appendChild(addWrapper);
    builderContainer.appendChild(builderHeader);

    const activeFormsContainer = document.createElement('div');
    activeFormsContainer.className = 'space-y-4';
    builderContainer.appendChild(activeFormsContainer);

    // Insert Builder
    const narrativeLabel = encodePanel.querySelector('label[for="narrative"]');
    if (narrativeLabel && narrativeLabel.parentElement) {
      encodePanel.insertBefore(builderContainer, narrativeLabel.parentElement);
    } else {
      encodePanel.insertBefore(builderContainer, encodePanel.firstChild);
    }

    function renderFormSection(domainKey) {
      const config = domainConfig[domainKey];
      const section = document.createElement('div');
      section.className = 'bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative group animate-[fadeIn_0.3s_ease-out]';
      section.dataset.domain = domainKey;

      if (config.icon) {
        const iconBg = document.createElement('div');
        iconBg.className = 'absolute -left-3 -top-3 w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center shadow-md z-10 border-2 border-slate-50';
        iconBg.innerHTML = `<i class="fa-solid ${config.icon} text-sm"></i>`;
        section.appendChild(iconBg);
      }

      // Header
      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-4 pl-3';

      const title = document.createElement('strong');
      title.className = `text-sm font-semibold text-slate-900 ${config.icon ? 'ml-2' : ''}`;
      title.textContent = config.label;
      header.appendChild(title);

      if (domainKey !== 'demographics') {
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        removeBtn.className = 'text-slate-400 hover:text-red-500 transition-colors w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100';
        removeBtn.title = 'Remove condition';
        removeBtn.onclick = () => {
          delete formState[domainKey];
          section.remove();
          updateNarrative();
        };
        header.appendChild(removeBtn);
      }
      section.appendChild(header);

      // Fields Grid
      const fieldsContainer = document.createElement('div');
      fieldsContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';

      config.fields.forEach(field => {
        // Logic for showIf (same as before)
        if (field.showIf) {
          let conditionMet = false;
          const complicationsValue = formState[domainKey]?.['Complications'];
          if (Array.isArray(complicationsValue) && complicationsValue.includes(field.showIf)) {
            conditionMet = true;
          }

          // RegEx style match/plain match for strings
          // Special handling for pipe delimited string options in showIf
          const criteriaOptions = field.showIf.split('|');
          // Check if ANY of the current form values in this domain match ANY of the criteria options
          Object.keys(formState[domainKey] || {}).forEach(key => {
            const value = formState[domainKey][key];
            if (typeof value === 'string' && criteriaOptions.includes(value)) {
              conditionMet = true;
            }
            // For strict key mapping if we had it, but here we just check if value exists in domain state
          });

          // Special direct check for certain fields if needed, but generic approach works for now based on previous logic
          // Re-implementing the specific check from previous file for 100% fidelity:
          // "For other select fields, check if value matches (supports pipe-separated values)"
          // "if (typeof value === 'string' && (value === field.showIf || field.showIf.includes(value)))" -> this was loose

          // Let's stick to the previous logic exactly to break nothing
          Object.keys(formState[domainKey] || {}).forEach(key => {
            const value = formState[domainKey][key];
            if (typeof value === 'string' && (value === field.showIf || field.showIf.includes(value))) {
              conditionMet = true;
            }
          });

          if (!conditionMet) return;
        }

        const fieldWrapper = document.createElement('div');

        const label = document.createElement('label');
        label.className = `block text-xs font-semibold mb-1.5 ${field.required ? 'text-slate-800' : 'text-slate-500'}`;
        label.innerHTML = `${field.label}${field.required ? ' <span class="text-red-500">*</span>' : ''}`;

        let input;
        if (field.type === 'checkbox-group') {
          input = document.createElement('div');
          input.className = 'space-y-2 pt-1';

          if (!formState[domainKey][field.key]) formState[domainKey][field.key] = [];

          field.options.forEach(opt => {
            const labelWrap = document.createElement('label');
            labelWrap.className = 'flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:text-slate-900';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = opt;
            checkbox.checked = formState[domainKey][field.key].includes(opt);
            checkbox.className = 'w-4 h-4 text-medical-600 border-slate-300 rounded focus:ring-medical-500';

            checkbox.addEventListener('change', (e) => {
              if (e.target.checked) {
                if (!formState[domainKey][field.key].includes(opt)) formState[domainKey][field.key].push(opt);
              } else {
                formState[domainKey][field.key] = formState[domainKey][field.key].filter(v => v !== opt);
              }
              updateNarrative();
              // Re-render for conditionals
              const currentSection = document.querySelector(`[data-domain="${domainKey}"]`);
              if (currentSection) {
                const parent = currentSection.parentElement;
                // We need to keep position, simplest is simple re-render in place logic or remove/add
                // But remove/add moves it to bottom if we blindly append.
                // Let's implementation replaceChild
                currentSection.replaceWith(renderFormSection(domainKey));
              }
            });

            labelWrap.appendChild(checkbox);
            labelWrap.appendChild(document.createTextNode(opt));
            input.appendChild(labelWrap);
          });

        } else if (field.type === 'select') {
          input = document.createElement('select');
          input.className = 'w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-medical-500 focus:border-transparent outline-none transition-shadow';

          const empty = document.createElement('option');
          empty.value = '';
          empty.text = '- Select -';
          input.appendChild(empty);

          field.options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.text = opt;
            if (formState[domainKey][field.key] === opt) o.selected = true;
            input.appendChild(o);
          });

          input.addEventListener('change', (e) => {
            formState[domainKey][field.key] = e.target.value;
            updateNarrative();
            // Re-render validation for dependent fields (like CKD stage dependent on CKD Present=Yes)
            if (['Yes', 'No', 'Foot Ulcer', 'Nephropathy/CKD'].some(v => e.target.value.includes(v))) {
              const currentSection = document.querySelector(`[data-domain="${domainKey}"]`);
              if (currentSection) currentSection.replaceWith(renderFormSection(domainKey));
            }
          });

        } else {
          input = document.createElement('input');
          input.type = field.type;
          input.className = 'w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-medical-500 focus:border-transparent outline-none transition-shadow placeholder:text-slate-400';
          input.placeholder = field.label;
          if (formState[domainKey][field.key]) input.value = formState[domainKey][field.key];

          input.addEventListener('input', (e) => {
            formState[domainKey][field.key] = e.target.value;
            updateNarrative();
          });
        }

        fieldWrapper.appendChild(label);
        fieldWrapper.appendChild(input);
        fieldsContainer.appendChild(fieldWrapper);
      });

      section.appendChild(fieldsContainer);
      if (domainKey === 'demographics' && activeFormsContainer.firstChild) {
        // Keep demographics at top theoretically, but in this logic we just append nicely
      }
      return section;
    }

    // Initial Render
    activeFormsContainer.appendChild(renderFormSection('demographics'));


    function updateNarrative() {
      const lines = [];
      const order = ['demographics', 'diabetes', 'ckd', 'cardio', 'respiratory', 'infection', 'wounds', 'neoplasm', 'injury', 'social'];

      order.forEach(domain => {
        if (formState[domain]) {
          const data = formState[domain];
          Object.keys(data).forEach(key => {
            const value = data[key];
            if (value && (!Array.isArray(value) || value.length > 0)) {
              lines.push(Array.isArray(value) ? `${key}: ${value.join(', ')}` : `${key}: ${value}`);
            }
          });
        }
      });
      narrativeInput.value = lines.join('\n');
    }

    // --- ENCODER LOGIC ---
    async function performEncode() {
      const text = narrativeInput.value.trim();
      encodeResults.innerHTML = '';
      encodeStatus.textContent = '';
      copyEncodeBtn.disabled = true;

      if (!text) {
        encodeStatus.innerHTML = '<span class="text-amber-500"><i class="fa-solid fa-triangle-exclamation"></i> Please enter a clinical narrative.</span>';
        return;
      }

      // Toggle GA4 event
      if (typeof gtag === 'function') {
        gtag('event', 'icd_search', {
          search_term: text,
          source: 'icd_engine'
        });
        console.log('GA4 Event Fired: icd_search', { search_term: text, source: 'icd_engine' });
      }

      encodeBtn.disabled = true;
      encodeBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';

      const lines = text.split(/\r?\n/).filter(l => l.trim());
      const isBatch = lines.length > 1 && lines.every(l => /^\d+[\.\)\s]/.test(l.trim()));

      try {
        const token = localStorage.getItem('token');
        const payloadBody = isBatch ? { items: lines.map(l => l.replace(/^\d+[\.\)\s]\s*/, '').trim()) } : { text };

        const response = await fetch('/api/encode-structured', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(payloadBody)
        });

        if (!response.ok) throw new Error('Encoding failed.');
        const data = await response.json();
        const finalData = data.data || data;

        lastEncoded = finalData;
        renderEncodeResults(finalData);
        const count = Array.isArray(finalData) ? finalData.length : 1;
        encodeStatus.innerHTML = `<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> ${count} case(s) processed successfully.</span>`;

        // Mobile UX: Scroll to results
        if (window.innerWidth < 1024) {
          // Scroll to top of page to account for sticky header and order-1 results
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

      } catch (err) {
        encodeStatus.innerHTML = `<span class="text-red-500 font-bold"><i class="fa-solid fa-circle-xmark"></i> ${err.message}</span>`;
      } finally {
        encodeBtn.disabled = false;
        encodeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Encode Scenario';
      }
    }

    let lastEncoded = null;

    function renderEncodeResults(payload) {
      encodeResults.innerHTML = '';
      const results = Array.isArray(payload) ? payload : [payload];

      if (!results.length) {
        encodeResults.innerHTML = '<div class="text-center py-8 text-slate-400">No results found.</div>';
        return;
      }

      results.forEach((result, index) => {
        const itemContainer = document.createElement('div');
        itemContainer.className = 'bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-6 animate-[fadeIn_0.5s_ease-out]';

        if (results.length > 1) {
          const header = document.createElement('div');
          header.className = 'bg-slate-50 px-4 py-3 border-b border-slate-200 font-medium text-slate-700 text-sm';
          header.textContent = `Case #${index + 1}: ${result.text.substring(0, 60)}${result.text.length > 60 ? '...' : ''}`;
          itemContainer.appendChild(header);
        }

        const content = document.createElement('div');
        content.className = 'p-4 space-y-3';

        if (!result.primary && (!result.secondary || !result.secondary.length)) {
          content.innerHTML = '<div class="p-3 bg-amber-50 text-amber-700 rounded-md border border-amber-200 text-sm">No codes were generated for this scenario.</div>';
        } else {
          const createCard = (code, type) => {
            const isPrimary = type === 'Primary';
            const colorClass = isPrimary ? 'border-medical-500' : 'border-slate-300';
            const bgClass = isPrimary ? 'bg-white' : 'bg-slate-50';
            const badgeClass = isPrimary ? 'bg-medical-100 text-medical-800' : 'bg-slate-200 text-slate-700';

            return `
                    <div class="border-l-4 ${colorClass} ${bgClass} rounded-r-md p-3 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-1 gap-2">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="text-xs font-bold uppercase tracking-wider ${badgeClass} px-2 py-0.5 rounded">${type}</span>
                                ${(code.annotations || []).map(a => `<span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-200">${a}</span>`).join('')}
                            </div>
                            <span class="font-mono text-lg font-bold text-slate-900 shrink-0">${code.code}</span>
                        </div>
                        <div class="text-sm text-slate-800 font-medium mb-1">${code.description || 'No description'}</div>
                        <div class="text-xs text-slate-500 italic border-t border-slate-100 pt-1 mt-1">
                           <div class="flex flex-wrap justify-between gap-2">
                                <span><i class="fa-solid fa-info-circle mr-1"></i> ${code.rationale}</span>
                                ${(code.references || []).length ? `<span class="text-slate-400" title="Reference"><i class="fa-solid fa-book-medical"></i> ${code.references.join(', ')}</span>` : ''}
                           </div>
                        </div>
                    </div>
                 `;
          };

          if (result.primary) {
            const el = document.createElement('div');
            el.innerHTML = createCard(result.primary, 'Primary');
            content.appendChild(el.firstChild.nextSibling || el.firstChild); // Handle HTML string parsing quirk
          }
          if (result.secondary) {
            result.secondary.forEach(code => {
              const el = document.createElement('div');
              el.innerHTML = createCard(code, 'Secondary');
              content.appendChild(el.firstChild.nextSibling || el.firstChild);
            });
          }
        }

        // Validation Errors
        if (result.validationErrors?.length) {
          const errDiv = document.createElement('div');
          errDiv.className = 'mt-4 bg-red-50 border border-red-200 rounded-md p-3';
          errDiv.innerHTML = `
                <div class="flex items-center gap-2 text-red-700 text-sm font-bold mb-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> Validation Alerts
                </div>
                <ul class="list-disc list-inside text-xs text-red-600 space-y-1">
                    ${result.validationErrors.map(e => `<li>${e}</li>`).join('')}
                </ul>
            `;
          content.appendChild(errDiv);
        }

        itemContainer.appendChild(content);
        encodeResults.appendChild(itemContainer);
      });

      copyEncodeBtn.disabled = false;
    }

    encodeBtn.addEventListener('click', performEncode);

    // Copy Logic
    document.getElementById('copyEncodeBtn').addEventListener('click', async () => {
      if (!lastEncoded) return;
      const results = Array.isArray(lastEncoded) ? lastEncoded : [lastEncoded];
      const lines = [];

      results.forEach((res, idx) => {
        if (results.length > 1) lines.push(`Case ${idx + 1}: ${res.text}`);
        if (res.primary) lines.push(`Primary: ${res.primary.code} - ${res.primary.label || res.primary.description}`);
        if (res.secondary && res.secondary.length) {
          res.secondary.forEach(c => lines.push(`Secondary: ${c.code} - ${c.label || c.description}`));
        }
        lines.push('');
      });

      try {
        await navigator.clipboard.writeText(lines.join('\n'));
        const originalText = document.getElementById('copyEncodeBtn').innerHTML;
        document.getElementById('copyEncodeBtn').innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
        setTimeout(() => {
          document.getElementById('copyEncodeBtn').innerHTML = '<i class="fa-regular fa-copy"></i> Copy All';
        }, 2000);
      } catch (e) { console.error(e); }
    });


    // --- BATCH LOGIC ---
    const batchInput = document.getElementById('batchFile');
    const processBatchBtn = document.getElementById('processBatchBtn');
    const batchStatus = document.getElementById('batchStatus');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const batchProgress = document.getElementById('batchProgress');
    const downloadBtn = document.getElementById('downloadResultsBtn');
    const fileLabel = document.getElementById('fileLabel');

    batchInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        fileLabel.textContent = file.name;
        processBatchBtn.disabled = false;
        batchStatus.textContent = '';
      }
    });

    document.getElementById('clearBatchBtn').addEventListener('click', () => {
      batchInput.value = '';
      fileLabel.textContent = 'TXT files only';
      processBatchBtn.disabled = true;
      downloadBtn.style.display = 'none';
      batchStatus.textContent = '';
      batchProgress.className = 'hidden mt-4';
    });

    processBatchBtn.addEventListener('click', async () => {
      const file = batchInput.files[0];
      if (!file) return;

      processBatchBtn.disabled = true;
      batchProgress.classList.remove('hidden');
      progressBar.style.width = '10%';
      progressText.textContent = 'Reading file...';

      try {
        const content = await file.text();
        progressBar.style.width = '40%';
        progressText.textContent = 'Processing with AI engine...';

        const token = localStorage.getItem('token');
        const res = await fetch('/api/batch-encode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ fileContent: content })
        });

        progressBar.style.width = '80%';

        if (!res.ok) throw new Error('Batch processing error');
        const data = await res.json();

        progressBar.style.width = '100%';
        progressText.textContent = 'Done!';

        if (data.success) {
          batchStatus.innerHTML = `<span class="text-green-600 font-bold"><i class="fa-solid fa-check-circle"></i> Complete! ${data.totalCases} cases processed.</span>`;
          window.batchData = data.output;
          downloadBtn.style.display = 'inline-flex';
          downloadBtn.onclick = () => {
            const blob = new Blob([data.output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit_results_${Date.now()}.txt`;
            a.click();
          };
        }

      } catch (e) {
        batchStatus.innerHTML = `<span class="text-red-600 font-bold">Error: ${e.message}</span>`;
      } finally {
        processBatchBtn.disabled = false;
      }
    });

  </script>
</body>

</html>